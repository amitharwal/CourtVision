<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Player Details</title>
  <link rel="stylesheet" href="/static/css/player_detail.css">
</head>
<body>
<div class="container">
  <header>
    <div class="logo">Court Vision üèÄ</div>
    <nav>
      <a href="/">Home</a>
      <a href="/players" class="active">Players</a>
      <a href="/team-trends">Teams</a>
      <a href="/shot-charts">Shot Charts</a>
      <a href="/compare">Compare</a>
      <a href="/advanced-metrics">Adv. Metrics</a>
    </nav>
  </header>

  <div class="back-link"><a href="/players">‚Üê Back to Player Explorer</a></div>

  <div class="player-layout">
    <!-- LEFT -->
    <aside class="player-sidebar" id="sidebar">
      <div class="player-card" id="player-card">
        <div class="player-avatar-large">..</div>
        <div class="player-card-body">
          <h1 id="p-name">Loading‚Ä¶</h1>
          <div class="player-meta" id="p-meta"></div>
          <div class="player-physical" id="p-phys"></div>
          <button class="compare-large-btn" id="compare-btn" disabled>Add to Compare</button>
        </div>
      </div>

      <div class="season-list">
        <h3>Seasons</h3>
        <ul id="season-list">
          <li class="loading">Loading seasons‚Ä¶</li>
        </ul>
      </div>
    </aside>

    <!-- RIGHT: Overview -->
    <main class="player-main">
      <div id="season-context" style="margin-bottom:12px; font-weight:600;"></div>
      <div id="badges" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px;"></div>

      <section class="stats-content">
        <div id="overview-tab" class="tab-content active">
          <div class="loading">Loading season stats‚Ä¶</div>
        </div>
      </section>
    </main>
  </div>

  <footer>
    ¬© 2025 Court Vision. Built with raw code and real data. <a href="/privacy_policy">Privacy Policy</a>
  </footer>
</div>

<script>
  const playerId = {{ player_id }};
  let payload = null;
  let currentSeason = null;

  document.addEventListener('DOMContentLoaded', () => {
    loadPlayer();
  });

  async function loadPlayer() {
    try {
      const res = await fetch(`/api/player/${playerId}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.error || 'player api failed');
      payload = data;

      renderHeader(data.player_info || {});
      renderSeasonList(data.available_seasons || []);

      if (data.available_seasons?.length) {
        selectSeason(data.available_seasons[0]); // newest
      } else {
        document.getElementById('overview-tab').innerHTML = '<p class="no-data">No regular-season data available.</p>';
      }
    } catch (e) {
      console.error(e);
      document.getElementById('overview-tab').innerHTML = '<p class="error">Failed to load player.</p>';
      document.getElementById('season-list').innerHTML = '<li class="error">Failed to load seasons.</li>';
    }
  }

  function renderHeader(info) {
    const initials = (info.DISPLAY_FIRST_LAST || 'NA').split(/\s+/).map(n => n[0]).join('');
    document.querySelector('#player-card .player-avatar-large').textContent = initials;
    document.getElementById('p-name').textContent = info.DISPLAY_FIRST_LAST || 'Unknown Player';
    document.getElementById('p-meta').textContent =
      `${info.TEAM_NAME || 'Free Agent'} ‚Ä¢ #${info.JERSEY || 'N/A'} ‚Ä¢ ${info.POSITION || 'N/A'}`;
    document.getElementById('p-phys').innerHTML =
      `<span>Height: ${info.HEIGHT || 'N/A'}</span>
       <span>Weight: ${info.WEIGHT || 'N/A'} lbs</span>
       <span>Born: ${info.BIRTHDATE ? new Date(info.BIRTHDATE).toLocaleDateString() : 'N/A'}</span>
       <span>Experience: ${info.SEASON_EXP || '0'} years</span>`;

    const compareBtn = document.getElementById('compare-btn');
    compareBtn.disabled = false;
    compareBtn.onclick = () => addToCompare(playerId, info.DISPLAY_FIRST_LAST || 'Player');
  }

  function renderSeasonList(seasons) {
    const ul = document.getElementById('season-list');
    ul.innerHTML = '';
    if (!seasons.length) {
      ul.innerHTML = '<li class="no-data">No seasons.</li>';
      return;
    }
    seasons.forEach(s => {
      const li = document.createElement('li');
      li.className = 'season-item';
      li.textContent = s;
      li.dataset.season = s;
      li.onclick = () => selectSeason(s);
      ul.appendChild(li);
    });
  }

  async function selectSeason(seasonId) {
    currentSeason = seasonId;
    document.querySelectorAll('#season-list .season-item').forEach(li => {
      li.classList.toggle('active', li.dataset.season === seasonId);
    });

    try {
      const res = await fetch(`/api/player/${playerId}?season=${encodeURIComponent(seasonId)}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.error || 'player api failed');
      payload = data;
      const sel = data.selected_season;
      updateSeasonContext(sel);
      renderBadges(sel);
      renderOverview(sel, data.seasons_regular || []);
    } catch (e) {
      console.error(e);
      updateSeasonContext(null);
      document.getElementById('overview-tab').innerHTML = `<p class="no-data">No Regular Season data for ${seasonId}.</p>`;
      document.getElementById('badges').innerHTML = '';
    }
  }

  function updateSeasonContext(sel) {
    const el = document.getElementById('season-context');
    if (!sel) { el.textContent = ''; return; }
    const teamLabel = sel.TEAM_NAME || sel.TEAM_ABBREVIATION || 'N/A';
    el.textContent = `Season: ${sel.SEASON_ID} ‚Ä¢ Team: ${teamLabel}`;
  }

  // Fun highlights to make the page pop (no CSS changes required)
  function renderBadges(sel) {
    const wrap = document.getElementById('badges');
    if (!sel) { wrap.innerHTML = ''; return; }

    const badges = [];
    if ((sel.PPG || 0) >= 30) badges.push('30+ PPG Scorer');
    else if ((sel.PPG || 0) >= 20) badges.push('20+ PPG Scorer');

    const fg = (sel.FG_PCT || 0);
    const tp = (sel.FG3_PCT || 0);
    const ft = (sel.FT_PCT || 0);
    if (fg >= 0.50 && tp >= 0.40 && ft >= 0.90) badges.push('50/40/90 Club');
    if ((sel.APG || 0) >= 7) badges.push('Primary Playmaker');
    if ((sel.RPG || 0) >= 10) badges.push('Double-Digit Rebounder');

    wrap.innerHTML = badges.map(b => `<span style="border:1px solid #000; padding:4px 8px; border-radius:6px; background:#fff">${b}</span>`).join(' ');
  }

  function fmtPct(v) { return (v == null ? 'N/A' : `${(+v).toFixed(1)}%`); }
  function fmt1(v)   { return (v == null ? '0.0' : (+v).toFixed(1)); }
  function safe(v)   { return v ?? 0; }

  function renderOverview(sel, seasonsTable) {
    const container = document.getElementById('overview-tab');
    if (!sel) {
      container.innerHTML = `<p class="no-data">No Regular Season data for ${currentSeason}.</p>`;
      return;
    }

    container.innerHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Per Game</h3>
          <div class="stat-item"><span>GP</span><span>${sel.GP}</span></div>
          <div class="stat-item"><span>GS</span><span>${sel.GS ?? 0}</span></div>
          <div class="stat-item"><span>MPG</span><span>${fmt1(sel.MPG)}</span></div>
          <div class="stat-item"><span>PPG</span><span>${fmt1(sel.PPG)}</span></div>
          <div class="stat-item"><span>RPG</span><span>${fmt1(sel.RPG)}</span></div>
          <div class="stat-item"><span>APG</span><span>${fmt1(sel.APG)}</span></div>
          <div class="stat-item"><span>SPG</span><span>${fmt1(sel.SPG)}</span></div>
          <div class="stat-item"><span>BPG</span><span>${fmt1(sel.BPG)}</span></div>
          <div class="stat-item"><span>TOV</span><span>${fmt1(sel.TOV)}</span></div>
        </div>

        <div class="stat-card">
          <h3>Shooting Quality</h3>
          <div class="stat-item"><span>FG%</span><span>${fmtPct((sel.FG_PCT || 0)*100)}</span></div>
          <div class="stat-item"><span>eFG%</span><span>${fmtPct(sel.EFG_PCT)}</span></div>
          <div class="stat-item"><span>TS%</span><span>${fmtPct(sel.TS_PCT)}</span></div>
          <div class="stat-item"><span>3P%</span><span>${fmtPct((sel.FG3_PCT || 0)*100)}</span></div>
          <div class="stat-item"><span>FT%</span><span>${fmtPct((sel.FT_PCT || 0)*100)}</span></div>
        </div>

        <div class="stat-card">
          <h3>Volume &amp; Discipline</h3>
          <div class="stat-item"><span>3PA Rate</span><span>${fmtPct(sel.THREEPAR)}</span></div>
          <div class="stat-item"><span>FT Rate</span><span>${fmtPct(sel.FTR)}</span></div>
          <div class="stat-item"><span>3PM/36</span><span>${fmt1(sel.FG3M_P36)}</span></div>
          <div class="stat-item"><span>FTA/36</span><span>${fmt1(sel.FTA_P36)}</span></div>
          <div class="stat-item"><span>FGA/36</span><span>${fmt1(sel.FGA_P36)}</span></div>
        </div>

        <div class="stat-card">
          <h3>Per 36 Minutes</h3>
          <div class="stat-item"><span>PTS/36</span><span>${fmt1(sel.PTS_P36)}</span></div>
          <div class="stat-item"><span>REB/36</span><span>${fmt1(sel.REB_P36)}</span></div>
          <div class="stat-item"><span>AST/36</span><span>${fmt1(sel.AST_P36)}</span></div>
          <div class="stat-item"><span>STL/36</span><span>${fmt1(sel.STL_P36)}</span></div>
          <div class="stat-item"><span>BLK/36</span><span>${fmt1(sel.BLK_P36)}</span></div>
          <div class="stat-item"><span>TOV/36</span><span>${fmt1(sel.TOV_P36)}</span></div>
        </div>

        <div class="stat-card">
          <h3>Totals</h3>
          <div class="stat-item"><span>MIN</span><span>${Math.round(safe(sel.MIN_TOTAL))}</span></div>
          <div class="stat-item"><span>PTS</span><span>${Math.round(safe(sel.PTS_TOTAL))}</span></div>
          <div class="stat-item"><span>REB</span><span>${Math.round(safe(sel.REB_TOTAL))}</span></div>
          <div class="stat-item"><span>AST</span><span>${Math.round(safe(sel.AST_TOTAL))}</span></div>
          <div class="stat-item"><span>STL</span><span>${Math.round(safe(sel.STL_TOTAL))}</span></div>
          <div class="stat-item"><span>BLK</span><span>${Math.round(safe(sel.BLK_TOTAL))}</span></div>
          <div class="stat-item"><span>TOV</span><span>${Math.round(safe(sel.TOV_TOTAL))}</span></div>
        </div>
      </div>

      <div class="career-stats-table" style="margin-top:24px;">
        <table>
          <thead>
            <tr>
              <th>Season</th><th>Team</th><th>GP</th><th>MIN</th><th>PTS</th>
              <th>REB</th><th>AST</th><th>FG%</th><th>3P%</th><th>FT%</th>
            </tr>
          </thead>
          <tbody>
            ${buildMiniTableRows(seasonsTable || [], currentSeason)}
          </tbody>
        </table>
      </div>
    `;
  }

  function buildMiniTableRows(seasons, activeSeason) {
    return seasons.map(s => {
      const gp = s.GP || 1;
      const pct = v => (v != null ? (v * 100).toFixed(1) + '%' : 'N/A');
      const active = s.SEASON_ID === activeSeason ? ' style="background:#fffbe6"' : '';
      const teamLabel = s.TEAM_NAME || s.TEAM_ABBREVIATION || 'N/A';
      return `
        <tr${active}>
          <td>${s.SEASON_ID}</td>
          <td>${teamLabel}</td>
          <td>${s.GP ?? 0}</td>
          <td>${(s.MIN/gp).toFixed(1)}</td>
          <td>${(s.PTS/gp).toFixed(1)}</td>
          <td>${(s.REB/gp).toFixed(1)}</td>
          <td>${(s.AST/gp).toFixed(1)}</td>
          <td>${pct(s.FG_PCT)}</td>
          <td>${pct(s.FG3_PCT)}</td>
          <td>${pct(s.FT_PCT)}</td>
        </tr>`;
    }).join('');
  }

  // compare helper
  function addToCompare(id, name){
    try {
      const list = JSON.parse(localStorage.getItem('compareList') || '[]');
      if (list.find(p => p.id === id)) return alert(`${name} is already in your comparison list`);
      if (list.length >= 4) return alert('You can compare up to 4 players at a time');
      list.push({ id, name });
      localStorage.setItem('compareList', JSON.stringify(list));
      alert(`${name} added to comparison. ${list.length}/4 players selected.`);
    } catch(e) {
      console.warn('addToCompare failed', e);
    }
  }
</script>
</body>
</html>